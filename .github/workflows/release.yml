name: Release

on:
  push:
    branches: [ master ]
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  
  android:
    name: Android
    runs-on: ubuntu-22.04
    environment: release
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
            distribution: temurin
            java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Write Android signing files
        shell: bash
        env:
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
            set -euo pipefail

            mkdir -p android

            if [[ -z "${ANDROID_KEY_PROPERTIES}" ]]; then
            echo "ERROR: Missing secret ANDROID_KEY_PROPERTIES"
            exit 1
            fi

            if [[ -z "${KEYSTORE_BASE64}" ]]; then
            echo "ERROR: Missing secret KEYSTORE_BASE64"
            exit 1
            fi

            # key.properties
            printf "%s" "${ANDROID_KEY_PROPERTIES}" > android/key.properties
            echo "android/key.properties written."

            # release.keystore
            echo "${KEYSTORE_BASE64}" | base64 --decode > android/release.keystore
            chmod 600 android/release.keystore
            echo "android/release.keystore written."

      - name: Pub get
        run: flutter pub get

      - name: Package Android (script)
        shell: bash
        run: bash scripts/package-android.sh

      - name: Upload artifact (Android)
        env:
                FLUTTER_APP_PATH: .
        uses: actions/upload-artifact@v4
        with:
          name: android-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  windows:
    name: Windows
    runs-on: windows-2022
    environment: release
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Install Inno Setup
        shell: powershell
        run: choco install innosetup -y

      - name: Pub get
        shell: powershell
        run: flutter pub get

      - name: Package Windows (script)
        shell: cmd
        run: scripts\package-windows.bat

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: windows-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  macos_universal:
    name: macOS arm64 + x86_64 (Universal)
    runs-on: macos-14
    environment: release
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Pub get
        run: flutter pub get
      - name: Install DMG dependencies
        shell: bash
        run: |
            set -euo pipefail
            brew install pipx
            pipx ensurepath
            pipx install dmgbuild

      - name: Package macOS (script)
        shell: bash
        run: bash scripts/package-macos.sh

      - name: Rename output to include arch
        shell: bash
        run: |
          set -euo pipefail
          if ls build/output/*.dmg >/dev/null 2>&1; then
            mv build/output/*.dmg build/output/yamata-launcher-installer.dmg
          fi

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: macos-arm-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  linux_x86:
    name: Linux x86_64 (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Install deps (Linux)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            python3 python3-pip patchelf \
            libfuse2 libayatana-appindicator3-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install appimage-builder

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Package Linux (script x86)
        shell: bash
        run: bash scripts/package-linux.sh x86

      - name: Upload artifact (Linux x86)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: linux-x86-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**
  release:
    name: Create GitHub Release
    needs:
      - android
      - windows
      - macos_universal
      - linux_x86
    runs-on: ubuntu-22.04
    environment: release
    permissions:
      contents: write

    outputs:
      version: ${{ steps.bump.outputs.version }}

    steps:
      - uses: actions/checkout@v4
      # -----------------------------------------
      # Version bump (pubspec.yml)
      # -----------------------------------------
      - name: Bump pubspec version
        id: bump
        shell: bash
        env:
          FLUTTER_APP_PATH: .
        run: |
          set -euo pipefail

          PUBSPEC="${{ env.FLUTTER_APP_PATH }}/pubspec.yaml"

          CURRENT_LINE="$(grep -E '^version:\s*' "$PUBSPEC")"
          CURRENT_VERSION="${CURRENT_LINE#version: }"

          # Split version: x.y.z+build
          BASE_VERSION="${CURRENT_VERSION%%+*}"
          BUILD_NUMBER="${CURRENT_VERSION##*+}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          NEW_PATCH=$((PATCH + 1))
          NEW_BUILD=$((BUILD_NUMBER + 1))

          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}+${NEW_BUILD}"

          echo "Current version: $CURRENT_VERSION"
          echo "New version:     $NEW_VERSION"

          # Replace version line
          sed -i "s/^version:.*/version: ${NEW_VERSION}/" "$PUBSPEC"

          # Export outputs
          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${NEW_VERSION%%+*}" >> "$GITHUB_OUTPUT"

      # -----------------------------------------
      # Commit & tag
      # -----------------------------------------
      - name: Commit version bump
        shell: bash
        env:
          FLUTTER_APP_PATH: .
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pubspec.yaml
          git commit -m "chore(release): bump version to ${{ steps.bump.outputs.version }}"
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin HEAD --tags

      # -----------------------------------------
      # Download artifacts
      # -----------------------------------------
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List files
        run: ls -R dist

      # -----------------------------------------
      # Create GitHub Release
      # -----------------------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: "Yamata Launcher v${{ steps.bump.outputs.version }}"
          body: |
            **Yamata Launcher v${{ steps.bump.outputs.version }}**

            - Automatic release from CI
            - Version bumped from pubspec.yml
            - Multi-platform build included

          files: |
            dist/**/*
