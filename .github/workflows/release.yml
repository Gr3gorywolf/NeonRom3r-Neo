name: Release

on:
  push:
    branches: [ master ]
    tags:
      - "v*"
  workflow_dispatch:
    

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check_version_changed:
    name: Check pubspec version changed
    runs-on: ubuntu-22.04
    environment: release
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pubspec_version: ${{ steps.check.outputs.pubspec_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: check
        shell: bash
        env:
            FLUTTER_APP_PATH: .
        run: |
          echo "should_run=true" >> "$GITHUB_OUTPUT"

  android:
    name: Android
    needs: [check_version_changed]
    if: needs.check_version_changed.outputs.should_run == 'true'
    runs-on: ubuntu-22.04
    environment: release
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
            distribution: temurin
            java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Write Android signing files
        shell: bash
        env:
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
            set -euo pipefail

            mkdir -p android

            if [[ -z "${ANDROID_KEY_PROPERTIES}" ]]; then
            echo "ERROR: Missing secret ANDROID_KEY_PROPERTIES"
            exit 1
            fi

            if [[ -z "${KEYSTORE_BASE64}" ]]; then
            echo "ERROR: Missing secret KEYSTORE_BASE64"
            exit 1
            fi

            # key.properties
            printf "%s" "${ANDROID_KEY_PROPERTIES}" > android/key.properties
            echo "android/key.properties written."

            # release.keystore
            echo "${KEYSTORE_BASE64}" | base64 --decode > android/release.keystore
            chmod 600 android/release.keystore
            echo "android/release.keystore written."

      - name: Pub get
        run: flutter pub get

      - name: Package Android (script)
        shell: bash
        run: bash scripts/package-android.sh

      - name: Upload artifact (Android)
        env:
                FLUTTER_APP_PATH: .
        uses: actions/upload-artifact@v4
        with:
          name: android-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  windows:
    name: Windows
    needs: [check_version_changed]
    if: needs.check_version_changed.outputs.should_run == 'true'
    runs-on: windows-2022
    environment: release
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Install Inno Setup
        shell: powershell
        run: choco install innosetup -y

      - name: Pub get
        shell: powershell
        run: flutter pub get

      - name: Build Windows (flutter)
        shell: powershell
        run: flutter build windows --release

      - name: Package Windows (script)
        shell: cmd
        run: scripts\package-windows.bat

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: windows-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  macos_arm:
    name: macOS arm64
    needs: [check_version_changed]
    if: needs.check_version_changed.outputs.should_run == 'true'
    runs-on: macos-14
    environment: release
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Pub get
        run: flutter pub get
      - name: Install DMG dependencies
        shell: bash
        run: |
            set -euo pipefail
            brew install pipx
            pipx ensurepath
            pipx install dmgbuild
      - name: Build macOS (flutter)
        run: flutter build macos --release

      - name: Package macOS (script)
        shell: bash
        run: bash scripts/package-macos.sh

      - name: Rename output to include arch
        shell: bash
        run: |
          set -euo pipefail
          if ls build/output/*.dmg >/dev/null 2>&1; then
            mv build/output/*.dmg build/output/yamata-launcher-installer-arm64.dmg
          fi

      - name: Upload artifact (macOS arm64)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: macos-arm-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**

  linux_x86:
    name: Linux x86_64 (Ubuntu 22.04)
    needs: [check_version_changed]
    if: needs.check_version_changed.outputs.should_run == 'true'
    runs-on: ubuntu-22.04
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Install deps (Linux)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            python3 python3-pip patchelf \
            libfuse2 libayatana-appindicator3-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install appimage-builder

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"
          channel: "stable"
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Package Linux (script x86)
        shell: bash
        run: bash scripts/package-linux.sh x86

      - name: Upload artifact (Linux x86)
        uses: actions/upload-artifact@v4
        env:
          FLUTTER_APP_PATH: .
        with:
          name: linux-x86-build-output
          path: ${{ env.FLUTTER_APP_PATH }}/build/output/**
  linux_arm:
        name: Linux arm64 (Ubuntu 22.04 ARM)
        needs: [check_version_changed]
        if: needs.check_version_changed.outputs.should_run == 'true'
        runs-on: ubuntu-22.04-arm

        env:
            FLUTTER_APP_PATH: .

        steps:
        - uses: actions/checkout@v4

        - name: Install deps (Linux ARM)
          shell: bash
          run: |
            set -euo pipefail

            FLUTTER_DIR="$HOME/flutter"

            git clone https://github.com/flutter/flutter.git "$FLUTTER_DIR"
            cd "$FLUTTER_DIR"
            git checkout 3.22.0

            # Make flutter available IMMEDIATELY
            export PATH="$FLUTTER_DIR/bin:$PATH"

            # Persist for next steps
            echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH

            flutter doctor

        - name: Install Flutter (ARM64 from source)
          shell: bash
          run: |
            set -euo pipefail

            git clone https://github.com/flutter/flutter.git "$HOME/flutter"
            cd "$HOME/flutter"
            git checkout 3.22.0

            echo "$HOME/flutter/bin" >> $GITHUB_PATH

            flutter doctor

        - name: Pub get
          shell: bash
          run: |
            cd "${FLUTTER_APP_PATH}"
            flutter pub get

        - name: Package Linux ARM (script)
          shell: bash
          run: |
            cd "${FLUTTER_APP_PATH}"
            bash scripts/package-linux.sh arm

        - name: Upload artifact (Linux ARM)
          uses: actions/upload-artifact@v4
          env:
            FLUTTER_APP_PATH: .
          with:
            name: linux-arm-build-output
            path: ${{ env.FLUTTER_APP_PATH }}/build/output/**
  release:
    name: Create GitHub Release
    needs:
      - check_version_changed
      - android
      - windows
      - macos_arm
      - linux_x86
      - linux_arm
    if: needs.check_version_changed.outputs.should_run == 'true'
    runs-on: ubuntu-22.04
    environment: release
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List files
        shell: bash
        run: |
          set -euo pipefail
          ls -R dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }} (pubspec: ${{ needs.check_version_changed.outputs.pubspec_version }})"
          files: |
            dist/**/*
